<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>前端进阶之事件循环机制-宏任务-微任务 - Thetiso&#039;s Tech Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Thetiso&#039;s Tech Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Thetiso&#039;s Tech Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="参考文档-思否参考文章有些错误，一边记录一边纠正。"><meta property="og:type" content="blog"><meta property="og:title" content="前端进阶之事件循环机制-宏任务-微任务"><meta property="og:url" content="http://thetiso.github.io/2021/06/01/%E5%89%8D%E7%AB%AF%E8%BF%9B%E9%98%B6%E4%B9%8B%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6/"><meta property="og:site_name" content="Thetiso&#039;s Tech Blog"><meta property="og:description" content="参考文档-思否参考文章有些错误，一边记录一边纠正。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://thetiso.github.io/img/og_image.png"><meta property="article:published_time" content="2021-06-01T08:12:13.000Z"><meta property="article:modified_time" content="2021-06-02T10:01:02.654Z"><meta property="article:author" content="Thetiso"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://thetiso.github.io/2021/06/01/%E5%89%8D%E7%AB%AF%E8%BF%9B%E9%98%B6%E4%B9%8B%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6/"},"headline":"Thetiso's Tech Blog","image":["http://thetiso.github.io/img/og_image.png"],"datePublished":"2021-06-01T08:12:13.000Z","dateModified":"2021-06-02T10:01:02.654Z","author":{"@type":"Person","name":"Thetiso"},"description":"参考文档-思否参考文章有些错误，一边记录一边纠正。"}</script><link rel="canonical" href="http://thetiso.github.io/2021/06/01/%E5%89%8D%E7%AB%AF%E8%BF%9B%E9%98%B6%E4%B9%8B%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Thetiso&#039;s Tech Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About Me</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-01T08:12:13.000Z" title="2021/6/1 下午4:12:13">2021-06-01</time>发表</span><span class="level-item"><time dateTime="2021-06-02T10:01:02.654Z" title="2021/6/2 下午6:01:02">2021-06-02</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%89%8D%E7%AB%AF%E8%BF%9B%E9%98%B6/">前端进阶</a></span><span class="level-item">19 分钟读完 (大约2872个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">前端进阶之事件循环机制-宏任务-微任务</h1><div class="content"><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039971920">参考文档-思否</a><br>参考文章有些错误，一边记录一边纠正。</p>
<a id="more"></a>

<h1><span id="js-de-ren-wu">js的任务</span><a href="#js-de-ren-wu" class="header-anchor">#</a></h1><ul>
<li>同步任务: 声明语句、for、赋值等，读取后依据从上到下从左到右，立即执行</li>
<li>异步任务:  ajax 网络请求，setTimeout 定时函数等都属于异步任务。</li>
</ul>
<p>异步任务会通过任务队列(Event Queue)的机制（先进先出的机制）来进行协调 =&gt; 队列</p>
<h1><span id="shi-jian-xun-huan-ji-zhi-amp-event-queue-amp-event-loop">事件循环机制 &amp; Event Queue &amp; Event Loop</span><a href="#shi-jian-xun-huan-ji-zhi-amp-event-queue-amp-event-loop" class="header-anchor">#</a></h1><p>先执行一个宏任务，执行过程中如果产出新的宏/微任务，就将他们推入相应的任务队列，之后在执行一队微任务，之后再执行宏任务，如此循环。以上不断重复的过程就叫做 **Event Loop(事件循环)**。</p>
<ul>
<li>宏任务 MacroTask 主要包括：script(JS 整体代码)、setTimeout、setInterval、setImmediate、I/O、UI 交互</li>
<li>微任务 MicroTask 主要包括：Promise(重点关注)、process.nextTick(Node.js)、MutaionObserver</li>
</ul>
<h2><span id="ju-li">举例</span><a href="#ju-li" class="header-anchor">#</a></h2><h4><span id="1-jian-dan-promise">1. 简单promise</span><a href="#1-jian-dan-promise" class="header-anchor">#</a></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;setTimeout&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;promise1&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;promise2&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script end&quot;</span>);</span><br><span class="line"><span class="comment">//...start</span></span><br><span class="line"><span class="comment">//...end</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//settimeout</span></span><br></pre></td></tr></table></figure>
<p><strong>第一阶段： 代码主体的宏任务</strong></p>
<ol>
<li>宏任务：输出 script start</li>
<li>遇到setTimeout() =&gt;  宏任务入队(函数内部的执行语句)。<ul>
<li>宏任务队列【setTimeout()的内部语句】, 微任务队列【】</li>
</ul>
</li>
<li>遇到Promise.resolve(), 宏任务</li>
<li>Promise.resolve().then() 为微任务，微任务入队。<ul>
<li>此时宏任务队列【setTimeout()的内部语句】, 微任务队列【包含promise1的函数体】</li>
</ul>
</li>
<li>Promise.resolve().then().then()为微任务， 微任务入队。   =&gt; <strong>这里的入队分析是错的</strong><ul>
<li>此时宏任务队列【setTimeout()的内部语句】, 微任务队列【包含promise1的函数体， 包含promise2的函数体】</li>
</ul>
</li>
<li>宏任务：输出 script end</li>
</ol>
<p><strong>第二阶段： 微任务队列</strong></p>
<ol>
<li>执行包含promise1的函数体=&gt; console.log(‘promise1’) =&gt; 输出promise1</li>
<li>执行包含promise2的函数体=&gt; console.log(‘promise2’) =&gt; 输出promise2</li>
</ol>
<p>第三阶段： <strong>UI渲染</strong>  </p>
<p><strong>第四阶段： 宏任务队列</strong></p>
<ul>
<li>setTimeout的函数体 =&gt; 输出 setTimeout</li>
</ul>
<p>但是在这里容易混淆的是promise链式语法，后面连续两个then:是两个微任务直接入队，还是第一个then包含着后面的then作为一个任务入队？</p>
<p><code>尝试区分promise1和promise2是怎么个流程</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;setTimeout&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;promise1&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;promise2&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;promise5&quot;</span>);</span><br><span class="line">  &#125;);;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;promise3&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;promise4&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script end&quot;</span>);</span><br><span class="line"><span class="comment">//..start</span></span><br><span class="line"><span class="comment">//..end</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//3</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//4</span></span><br><span class="line"><span class="comment">//settimeout</span></span><br></pre></td></tr></table></figure>
<p>按照参考文章中的分析，Promise.resolve()后面的then语法应当看做是一个整体Promise,并将其加入微任务队列。<br>至此，上面代码的完整流程应该是这样的</p>
<p><strong>第一阶段： 代码主题的宏任务</strong></p>
<ol>
<li>宏任务：输出 script start</li>
<li>遇到setTimeout() =&gt;  宏任务入队(函数内部的执行语句)。<ul>
<li>宏任务队列【setTimeout()的内部语句】, 微任务队列【】</li>
</ul>
</li>
<li>遇到Promise.resolve(), 宏任务</li>
<li>Promise.resolve().then() 为微任务，微任务入队。<ul>
<li>此时宏任务队列【setTimeout()的内部语句】, 微任务队列【包含promise1的函数体及其后续的then】</li>
</ul>
</li>
<li>第二个Promise.resolve().then() 为微任务，微任务入队。<ul>
<li>此时宏任务队列【setTimeout()的内部语句】, 微任务队列【包含promise1的函数体及其后续的then， 包含promise3的函数体及其后续的then】</li>
</ul>
</li>
<li>宏任务：输出 script end</li>
</ol>
<p><strong>第二阶段： 微任务队列</strong></p>
<ol>
<li>执行包含promise1的函数体及其后面的then<ul>
<li>console.log(‘promise1’) =&gt; 输出promise1</li>
<li>后续的then()作为新的微任务入队<ul>
<li>此时的微任务队列：【包含promise3的函数体及其后续的then， 包含promise2的函数体】</li>
</ul>
</li>
</ul>
</li>
<li>执行包含promise3的函数体及其后续的then<ul>
<li>console.log(‘promise3’) =&gt; 输出promise3</li>
<li>后续的then()作为新的微任务入队<ul>
<li>此时的微任务队列：【包含promise3的函数体及其后续的then， 包含promise4的函数体】</li>
</ul>
</li>
</ul>
</li>
<li>执行包含promise2的函数体<ul>
<li>console.log(‘promise2’) =&gt; 输出promise2</li>
<li>如果promise2函数体后面还有then的话，这时候就会继续追加到微任务队列的末尾</li>
</ul>
</li>
<li>执行包含promise4的函数体<ul>
<li>console.log(‘promise4’) =&gt; 输出promise4 =&gt; 微任务队列清空</li>
</ul>
</li>
</ol>
<p>第三阶段： <strong>UI渲染</strong>  </p>
<p><strong>第四阶段： 宏任务队列</strong></p>
<ul>
<li>setTimeout的函数体 =&gt; 输出 setTimeout<ul>
<li>如果timeout的函数体里面还有微任务的话，这时候就会重新第二阶段</li>
</ul>
</li>
</ul>
<h4><span id="2-promise-resolve-gt-resolve-hui-diao-qian-hou-de-dai-ma-shu-yu-hong-ren-wu">2. Promise.resolve() =&gt; resolve回调前后的代码属于宏任务</span><a href="#2-promise-resolve-gt-resolve-hui-diao-qian-hou-de-dai-ma-shu-yu-hong-ren-wu" class="header-anchor">#</a></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;timeout1&quot;</span>);</span><br><span class="line">&#125;, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;promise1&quot;</span>);</span><br><span class="line">  resolve();</span><br><span class="line">  <span class="comment">//console.log(&#x27;test&#x27;)</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;timeout2&quot;</span>), <span class="number">10</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;then1&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script end&quot;</span>);</span><br><span class="line"><span class="comment">//...start</span></span><br><span class="line"><span class="comment">//promise1</span></span><br><span class="line"><span class="comment">//...end</span></span><br><span class="line"><span class="comment">//then1</span></span><br><span class="line"><span class="comment">//timeout1</span></span><br><span class="line"><span class="comment">//timeout2</span></span><br></pre></td></tr></table></figure>
<p><strong>第一阶段： 宏任务</strong></p>
<ol>
<li>宏任务：输出 script start</li>
<li>setTimeout函数体入队<ul>
<li>宏任务队列【包含setTimeout1的函数体】</li>
</ul>
</li>
<li>resolve()回调前的代码属于当前宏任务：输出promise1</li>
<li>resolve()引出的是后续跟着的then()函数=&gt; Promise对象 =&gt; 微任务入队<ul>
<li>微任务队列【包含then1的函数体】</li>
</ul>
</li>
<li>resolve()后面的代码：settimeout函数体入队<ul>
<li>宏任务【包含setTimeout1的函数体， 包含setTimeout2的函数体】</li>
</ul>
</li>
<li>宏任务: 输出script end</li>
</ol>
<p><strong>第二阶段： 微任务队列</strong></p>
<ol>
<li>输出then1 =&gt; 微任务队列清空</li>
</ol>
<p>第三阶段：<strong>UI渲染</strong></p>
<p><strong>第四阶段： 宏任务队列</strong></p>
<ol>
<li>包含setTimeout1的函数体出队：输出timeout1</li>
<li>包含setTimeout2的函数体出队：输出timeout2</li>
<li>宏任务队列清空</li>
</ol>
<h4><span id="3-async-han-shu-he-await">3. async函数和await</span><a href="#3-async-han-shu-he-await" class="header-anchor">#</a></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async/await 写法</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;async1 start&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;async1 end&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Promise 写法</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;async1 start&quot;</span>);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve(async2()).then(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;async1 end&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意区分await前后代码所在的任务队列 =&gt; 与resolve()不一样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;async1 start&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;async1 end&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;async2&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">async1();</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;promise1&quot;</span>);</span><br><span class="line">  resolve();</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;promise2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script end&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>第一阶段：</strong></p>
<ol>
<li>进入async1函数，输出： async1 start</li>
<li>遇到await =&gt; 进入async2函数体，相当于Promise.resolve() =&gt; 输出async2<ul>
<li>将后续代码加入微任务：相当于后面的代码是promise.resolve().then()函数体</li>
<li>微任务【包含async1 end的代码片段】</li>
</ul>
</li>
<li>settimeout立即执行函数=&gt; 宏任务入队<ul>
<li>宏任务【包含timeout的函数体】</li>
</ul>
</li>
<li>遇到new Promise()函数<ul>
<li>resolve()前的代码属于宏任务： 输出promise1</li>
<li>resolve()使后续的then()进入微任务<ul>
<li>微任务【包含async1 end的代码片段， 包含promise2的函数体】</li>
</ul>
</li>
</ul>
</li>
<li>输出 script end</li>
</ol>
<p><strong>第二阶段：微任务队列</strong></p>
<ol>
<li><code>包含async1 end的代码片段</code>出队 =&gt; 输出 async end</li>
<li><code>包含promise2的函数体</code>出队 =&gt; 输出 promise2</li>
</ol>
<p>第三阶段： <strong>UI渲染</strong></p>
<p><strong>第四阶段：</strong></p>
<ol>
<li><code>包含timeout的函数体</code>出队 =&gt; 输出 timeout</li>
</ol>
<h2><span id="zong-jie">总结</span><a href="#zong-jie" class="header-anchor">#</a></h2><p>“任务队列”是一个事件的队列（也可以理解成消息的队列），IO设备完成一项任务，就在”任务队列”中添加一个事件，表示相关的异步任务可以进入”执行栈”了。主线程读取”任务队列”，就是读取里面有哪些事件。<br>“任务队列”中的事件，除了IO设备的事件以外，还包括一些用户产生的事件（比如鼠标点击、页面滚动等等）。只要指定过回调函数，这些事件发生时就会进入”任务队列”，等待主线程读取。<br>所谓”回调函数”（callback），就是那些会被主线程挂起来的代码。异步任务必须指定回调函数，当主线程开始执行异步任务，就是执行对应的回调函数。<br>“任务队列”是一个先进先出的数据结构，排在前面的事件，优先被主线程读取。主线程的读取过程基本上是自动的，只要执行栈一清空，”任务队列”上第一位的事件就自动进入主线程。但是，由于存在后文提到的”定时器”功能，主线程首先要检查一下执行时间，某些事件只有到了规定的时间，才能返回主线程。</p>
<p><strong>JavaScript中没有任何代码是立即执行的，都是进程空闲时尽快执行</strong></p>
<h2><span id="guan-yu-settimeout">关于setTimeout</span><a href="#guan-yu-settimeout" class="header-anchor">#</a></h2><p>由上我们已经知道了 setTimeout 是一个宏任务，会被添加到宏任务队列当中去，按顺序执行。<br>setTimeout() 的第二个参数是为了告诉 JavaScript 再过多长时间把当前任务添加到队列中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> st = <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;timeout1&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds() - st);</span><br><span class="line"></span><br><span class="line">&#125;, <span class="number">1000</span>); <span class="comment">//修改了加入队列的时间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;promise1&quot;</span>);</span><br><span class="line">  resolve();</span><br><span class="line">  <span class="comment">//console.log(&#x27;test&#x27;)</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;timeout2&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds() - st), <span class="number">10</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;then1&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script end&quot;</span>);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//timeout2 0</span></span><br><span class="line"><span class="comment">//timeout1 1</span></span><br></pre></td></tr></table></figure>
<p>修改前面的代码， 调整两个timeout的时间。 <strong><em>timeout2先于timeout1输出</em></strong>。<br>如果队列是空的，那么添加的代码会立即执行；如果队列不是空的，那么它就要等前面的代码执行完了以后再执行。</p>
<p>再看下面的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;promise&quot;</span>);</span><br><span class="line">  resolve();</span><br><span class="line">&#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;then1&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds() - s &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;while&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds() - s);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds() - s)</span><br><span class="line">&#125;, <span class="number">2000</span>); <span class="comment">//7000</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script end&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为then是一个微任务，会先于setTimeout执行，所以，虽然setTimeout是在两秒后加入的宏任务队列，但是因为then中的在while操作被延迟了4s，所以一直推迟到了4s秒后才执行的setTimeout。</p>
<p>所以输出的顺序是：script start -&gt; promise  -&gt; script end -&gt; then1。<br>四秒后输出：while, 4 -&gt; undefined(UI渲染) -&gt; timeout, 4<br>=&gt; 由此可以看出当微任务已经执行结束的时候，时间已经过去4s，大于setTimeout设置的2000毫秒，随机直接执行setTimeout的函数体<br>=&gt; 我们进一步修改setTimeout的时间设置为7000ms，打印结果为while, 4 -&gt; undefined(UI渲染 -&gt; timeout, 7<br>=&gt; <strong><em>setTimeout入队出队的顺序没有变动，只是函数体内的代码片段执行得按照时间来确认先后顺序</em></strong>，这就得额外考虑微任务的执行时间，如果第四阶段的宏任务都是setTimeout的话，那么打印内容的先后就是按照设置的时间延迟来决定的。<br>=&gt; 进一步在setTimeout中设置微任务来确认这个理解是否正确</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> st = <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;timeout1&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds() - st);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">	  <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;timeout3&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds() - st)</span><br><span class="line">	  &#125;, <span class="number">3000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">1000</span>); <span class="comment">//修改了加入队列的时间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;promise1&quot;</span>);</span><br><span class="line">  resolve();</span><br><span class="line">  <span class="comment">//console.log(&#x27;test&#x27;)</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;timeout2&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds() - st), <span class="number">10</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;then1&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;script end&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>输出结果是 ：</p>
<ul>
<li>timeout2 0</li>
<li>timeout1 1</li>
<li>timeout3 4</li>
</ul>
<p>可见，timeout1的函数体实在1秒后将包含timeout3的函数体加入了微任务</p>
<p>注意：关于 setTimeout 要补充的是，即便主线程为空，0 毫秒实际上也是达不到的。根据 HTML 的标准，最低是 4 毫秒。有兴趣的同学可以自行了解。</p>
<p>… 貌似又多了一题奇怪的面试题。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>前端进阶之事件循环机制-宏任务-微任务</p><p><a href="http://thetiso.github.io/2021/06/01/前端进阶之事件循环机制/">http://thetiso.github.io/2021/06/01/前端进阶之事件循环机制/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Thetiso</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-06-01</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-06-02</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/06/03/%E5%89%8D%E7%AB%AF%E6%9D%82%E8%AE%B0%E4%B9%8Bjsfuck/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">前端杂记之jsfuck</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/05/08/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80%E4%B9%8B%E8%B7%A8%E5%9F%9F%E9%82%A3%E7%82%B9%E4%BA%8B%E5%84%BF/"><span class="level-item">前端基础之跨域CORS那点事儿</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "622ab7df0969c9b8c41c155860ef7c67",
            repo: "blog-site-comments",
            owner: "thetiso",
            clientID: "6fc0041775b201d6de94",
            clientSecret: "6e7e41e3c9efa52eaa1712f435f3890d4325596b",
            admin: ["thetiso"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Thetiso&#039;s Tech Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 Thetiso</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>