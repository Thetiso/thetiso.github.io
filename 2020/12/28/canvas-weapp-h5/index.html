<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>canvas-weapp-h5 - Thetiso&#039;s Tech Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Thetiso&#039;s Tech Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Thetiso&#039;s Tech Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="忙完公司关于海报制作的需求，开这篇文章扯扯canvas！"><meta property="og:type" content="blog"><meta property="og:title" content="canvas-weapp-h5"><meta property="og:url" content="http://thetiso.github.io/2020/12/28/canvas-weapp-h5/"><meta property="og:site_name" content="Thetiso&#039;s Tech Blog"><meta property="og:description" content="忙完公司关于海报制作的需求，开这篇文章扯扯canvas！"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://thetiso.github.io/img/og_image.png"><meta property="article:published_time" content="2020-12-28T09:48:18.000Z"><meta property="article:modified_time" content="2021-01-20T08:18:02.722Z"><meta property="article:author" content="Thetiso"><meta property="article:tag" content="fabric.js"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://thetiso.github.io/2020/12/28/canvas-weapp-h5/"},"headline":"Thetiso's Tech Blog","image":["http://thetiso.github.io/img/og_image.png"],"datePublished":"2020-12-28T09:48:18.000Z","dateModified":"2021-01-20T08:18:02.722Z","author":{"@type":"Person","name":"Thetiso"},"description":"忙完公司关于海报制作的需求，开这篇文章扯扯canvas！"}</script><link rel="canonical" href="http://thetiso.github.io/2020/12/28/canvas-weapp-h5/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Thetiso&#039;s Tech Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About Me</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-28T09:48:18.000Z" title="12/28/2020, 5:48:18 PM">2020-12-28</time>发表</span><span class="level-item"><time dateTime="2021-01-20T08:18:02.722Z" title="1/20/2021, 4:18:02 PM">2021-01-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/canvas/">canvas</a></span><span class="level-item">24 分钟读完 (大约3620个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">canvas-weapp-h5</h1><div class="content"><p>忙完公司关于海报制作的需求，开这篇文章扯扯canvas！</p>
<a id="more"></a>

<div class="toc">

<!-- toc -->

<ul>
<li><a href="#fabric-js">fabric.js</a><ul>
<li><a href="#hua-bu-canvas">画布 canvas</a></li>
<li><a href="#wen-ben-tu-pian-zui-ji-ben-de-hai-bao-yao-su">文本、图片：最基本的海报要素</a><ul>
<li><a href="#text">Text</a></li>
<li><a href="#image">Image</a></li>
<li><a href="#tu-ceng-gao-du">图层高度</a></li>
</ul>
</li>
<li><a href="#zi-ding-yi-bian-ji-kuang">自定义编辑框</a></li>
<li><a href="#zi-ding-yi-bian-ji-gong-neng">自定义编辑功能</a></li>
</ul>
</li>
<li><a href="#lian-diao">联调</a><ul>
<li><a href="#1-shou-quan-yan-zheng">1. 授权验证</a><ul>
<li><a href="#we-app">WE-APP</a></li>
<li><a href="#app-rn">APP(RN)</a></li>
</ul>
</li>
<li><a href="#2-xuan-ze-zhao-pian">2. 选择照片</a><ul>
<li><a href="#we-app-1">WE-APP</a></li>
<li><a href="#app-rn-1">APP(RN)</a></li>
</ul>
</li>
<li><a href="#3-chuan-di-shu-ju">3. 传递数据</a><ul>
<li><a href="#we-app-2">WE-APP</a></li>
<li><a href="#app-rn-2">APP(RN)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#note">NOTE</a><ul>
<li><a href="#safearea">safeArea</a></li>
<li><a href="#qrcode-er-wei-ma">qrcode 二维码</a></li>
<li><a href="#fabricobject-zi-ding-yi-fu-jia-zi-duan">fabricObject自定义附加字段</a></li>
<li><a href="#fu-wu-duan-chu-li">服务端处理</a></li>
<li><a href="#jie-qu-zhi-ding-qu-yu">截取指定区域</a></li>
<li><a href="#zi-ti">字体</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<hr>
<p>最开始的需求是在小程序内简单实现可以手动编辑的海报，不是根据数据直接套模板生成海报。找了github, 最终选的是疑似酷家乐团队的<a target="_blank" rel="noopener" href="https://github.com/Kujiale-Mobile/Painter">Painter</a>。用下来基本能满足需求，但是遇到了两个问题：</p>
<ul>
<li>新需求：可能需要整APP，那就意味着我得有个RN下的canvas组件、或者就是H5上整canvas;</li>
<li>调试困难：不知道是不是系统原因还是啥，mac上跑小程序编辑器一直都不是很流畅，一旦页面上跑得东西多了，动不动就可以去喝杯咖啡.. sad</li>
</ul>
<p>接下来的小程序页面中又多加了一个需求：需要将整好的数据直接导出成图片。 首先想到的就是wxml-to-canvas。 用这还行，不过考虑到后续APP也会有相同的需求，最终把wxml-to-canvas放下，选择了H5上的canvas方案。<br>wxml-to-canvas没法直接使用iconfont, 得把icon换成img才行。</p>
<p>在H5的现有方案中，首先选中的是小飞飞的<a target="_blank" rel="noopener" href="https://github.com/Gitjinfeiyang/easy-canvas">easy-canvas</a>. 但这个项目尚未支持z-index, 担心后续有图层调整相关的要求，无奈放弃。在小飞飞推荐下，开始折腾<a target="_blank" rel="noopener" href="https://github.com/fabricjs/fabric.js">fabric.js</a></p>
<p>不用翻墙就能看的<a target="_blank" rel="noopener" href="http://fabricjs.com/">官网地址</a></p>
<p>github上有好心的前人写了<a target="_blank" rel="noopener" href="https://github.com/Rookie-Birds/Fabric-Tutorial_zh-CN">中文文档</a>. 稍微有点久远，不过用来初步入门已经足够了。</p>
<p>在此，就不赘述一些基本使用方法，直接按照项目中常见的需求来展开。</p>
<h1><span id="fabric-js">fabric.js</span><a href="#fabric-js" class="header-anchor">#</a></h1><h2><span id="hua-bu-canvas">画布 canvas</span><a href="#hua-bu-canvas" class="header-anchor">#</a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;canvas-box&quot;&gt;</span><br><span class="line">        &lt;canvas id&#x3D;&quot;canvas&quot; :width&#x3D;&#39;width&#39; :height&#x3D;&#39;height&#39;&gt;&lt;&#x2F;canvas&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;fabric&#125; from &#39;fabric&#39;;</span><br><span class="line">export default &#123;</span><br><span class="line">    data: ()&#x3D;&gt; (&#123;</span><br><span class="line">        width: 360,</span><br><span class="line">        height: 640,</span><br><span class="line">        canvas: &#39;&#39;</span><br><span class="line">    &#125;),</span><br><span class="line">    created: function() &#123;</span><br><span class="line">        &#x2F;&#x2F;预加载数据,组装等</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted: function() &#123;</span><br><span class="line">        &#x2F;&#x2F;canvas赋值必须得等页面加载之后才行</span><br><span class="line">        this.canvas &#x3D; new fabric.Canvas(&#39;canvas&#39;) </span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<h2><span id="wen-ben-tu-pian-zui-ji-ben-de-hai-bao-yao-su">文本、图片：最基本的海报要素</span><a href="#wen-ben-tu-pian-zui-ji-ben-de-hai-bao-yao-su" class="header-anchor">#</a></h2><p>fabric.js项目作者将所有画布上的对象抽象为fabric.Object。其他所有的文本、图像之类全是基于这个基类。</p>
<h4><span id="text">Text</span><a href="#text" class="header-anchor">#</a></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    text: <span class="string">&#x27;文本内容&#x27;</span>,</span><br><span class="line">    <span class="comment">//这里有借鉴Painter项目</span></span><br><span class="line">    css: &#123;</span><br><span class="line">        left: <span class="number">100</span>,</span><br><span class="line">        top: <span class="number">100</span>,</span><br><span class="line">        fontWeight: <span class="number">600</span>,</span><br><span class="line">        color: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> text = <span class="keyword">new</span> fabric.Text(</span><br><span class="line">    obj.text,</span><br><span class="line">    &#123; </span><br><span class="line">        left: obj.css.left, </span><br><span class="line">        top: obj.css.top,</span><br><span class="line">        fontFamily: <span class="string">&#x27;Comic Sans&#x27;</span> ,</span><br><span class="line">        fontSize: obj.css.fontSize || <span class="number">20</span>,</span><br><span class="line">        fontWeight: obj.css.fontWeight,</span><br><span class="line">        fill:obj.css.color,</span><br><span class="line">        originX: obj.css.originX ||<span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="comment">//绑定点击(选中)事件，默认是支持的，这里是为了调用自定义的编辑框</span></span><br><span class="line">text.on(<span class="string">&#x27;selected&#x27;</span>, _this.selectedHandle)</span><br><span class="line"><span class="comment">//可以配置fabric.Object不可被选中</span></span><br><span class="line">text.set(<span class="string">&#x27;selectable&#x27;</span>, !!obj.editAble);</span><br><span class="line"><span class="built_in">this</span>.canvas.add(text);</span><br><span class="line"><span class="comment">//moveTo方法将在后续控制层高的地方讲到</span></span><br><span class="line">text.moveTo(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>Text有个进阶的Object: <a target="_blank" rel="noopener" href="http://fabricjs.com/docs/fabric.IText.html">IText</a></p>
<p>tips:</p>
<ul>
<li><strong>Text可以设置padding</strong>, 默认的编辑框border距离文本实在是太近了，尤其是需要自定义编辑框按钮的时候，挨得太近根本没办法好好显示按钮，<br>通过设置这个参数，就可以开心的留一些区域给按钮啦</li>
</ul>
<h4><span id="image">Image</span><a href="#image" class="header-anchor">#</a></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加载跨域图片</span></span><br><span class="line"><span class="keyword">new</span> fabric.Image.fromURL(obj.url, <span class="function"><span class="keyword">function</span>(<span class="params">img</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//这里img.width/height是图片的原始宽高，单位px</span></span><br><span class="line">    <span class="built_in">console</span>.log(img.width , img.height, obj.css.width)</span><br><span class="line">    <span class="keyword">let</span> scaleRatio = obj.css.width / img.width </span><br><span class="line">    <span class="comment">//通过scale使图片适应设定的宽高</span></span><br><span class="line">    img.scale(scaleRatio); </span><br><span class="line">    <span class="comment">//可以设置翻转</span></span><br><span class="line">    <span class="comment">// oImg.scale(0.5).set(&#x27;flipX, true);</span></span><br><span class="line">    img.on(<span class="string">&#x27;selected&#x27;</span>, _this.selectedHandle)</span><br><span class="line">    img.top = obj.css.top</span><br><span class="line">    img.left = obj.css.left</span><br><span class="line">    <span class="comment">//不设置height,避免选择框不能匹配图像边缘</span></span><br><span class="line">    img.on(<span class="string">&#x27;selected&#x27;</span>, _this.selectedHandle)</span><br><span class="line">    img.set(<span class="string">&#x27;selectable&#x27;</span>, !!obj.editAble);</span><br><span class="line">&#125;, &#123;<span class="attr">crossOrigin</span>: <span class="string">&#x27;anonymous&#x27;</span>&#125;)</span><br><span class="line"><span class="comment">//加载本地图片</span></span><br><span class="line"><span class="comment">// &lt;canvas id=&quot;c&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="comment">// &lt;img src=&quot;my_image.png&quot; id=&quot;my-image&quot;&gt;</span></span><br><span class="line"><span class="keyword">var</span> canvas = <span class="keyword">new</span> fabric.Canvas(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> imgElement = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;my-image&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> imgInstance = <span class="keyword">new</span> fabric.Image(imgElement, &#123;</span><br><span class="line">    left: <span class="number">100</span>,</span><br><span class="line">    top: <span class="number">100</span>,</span><br><span class="line">    angle: <span class="number">30</span>,</span><br><span class="line">    opacity: <span class="number">0.85</span></span><br><span class="line">&#125;);</span><br><span class="line">canvas.add(imgInstance);</span><br></pre></td></tr></table></figure>
<ol>
<li>加载跨域图片时候需要设置crossOrigin参数。</li>
<li>所有的fabric.Object下子类都是公用编辑框(controls)的</li>
<li>加载图片是个异步操作，不能保证所有Object的先后顺序。这就需要配合之前所说的moveTo函数来控制其图层高度。</li>
</ol>
<h4><span id="tu-ceng-gao-du">图层高度</span><a href="#tu-ceng-gao-du" class="header-anchor">#</a></h4><p><a target="_blank" rel="noopener" href="https://github.com/fabricjs/fabric.js/wiki/FAQ">点此查看介绍文档</a></p>
<p>图层高度同z-index, 数值大的可以遮挡数值小的。<br>控制图层一般用到这几个方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">obj.bringToFront(); <span class="comment">// 置顶</span></span><br><span class="line">obj.bringForward(); <span class="comment">// 向上一层</span></span><br><span class="line">obj.sendToBack(); <span class="comment">// 置底</span></span><br><span class="line">obj.sendBackwards(); <span class="comment">// 向下一层</span></span><br><span class="line">obj.moveTo(n); <span class="comment">// 设置层高N</span></span><br></pre></td></tr></table></figure>
<h2><span id="zi-ding-yi-bian-ji-kuang">自定义编辑框</span><a href="#zi-ding-yi-bian-ji-kuang" class="header-anchor">#</a></h2><p>fabric.js自带的编辑框还是蛮丑的…</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">selectedHandle: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//getActiveObject()可以获取当前被选中的对象 -&gt; 进而获取其类型</span></span><br><span class="line">    <span class="keyword">let</span> type = <span class="built_in">this</span>.canvas.getActiveObject() ? <span class="built_in">this</span>.canvas.getActiveObject().type : <span class="literal">null</span></span><br><span class="line">    type &amp;&amp; <span class="built_in">this</span>.setupEditBox(type)</span><br><span class="line">    <span class="comment">//如果是文本, 则显示文本编辑菜单，如果是图片则显示图片菜单</span></span><br><span class="line">    <span class="built_in">this</span>.showTextMenu = type == <span class="string">&#x27;text&#x27;</span></span><br><span class="line">    <span class="built_in">this</span>.showImgMenu = type == <span class="string">&#x27;image&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">setupEditBox: <span class="function"><span class="keyword">function</span>(<span class="params">targetType</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//首先隐藏默认的编辑框上的所有小点(按钮)</span></span><br><span class="line">    <span class="built_in">Object</span>.values(fabric.Object.prototype.controls).forEach(<span class="function"><span class="params">c</span> =&gt;</span> c.visible = <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//可以理解为原生按钮支持的事件handler</span></span><br><span class="line">    <span class="keyword">let</span> controlsUtils = fabric.controlsUtils,</span><br><span class="line">        scaleSkewStyleHandler = controlsUtils.scaleSkewCursorStyleHandler,</span><br><span class="line">        scaleStyleHandler = controlsUtils.scaleCursorStyleHandler,</span><br><span class="line">        scalingEqually = controlsUtils.scalingEqually,</span><br><span class="line">        scalingYOrSkewingX = controlsUtils.scalingYOrSkewingX,</span><br><span class="line">        scalingXOrSkewingY = controlsUtils.scalingXOrSkewingY,</span><br><span class="line">        scaleOrSkewActionName = controlsUtils.scaleOrSkewActionName,</span><br><span class="line">        objectControls = fabric.Object.prototype.controls;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//icon直接用的base64 png图片，这里不适合全部黏贴上来，后续补充demo的时候，可以去demo查看</span></span><br><span class="line">    <span class="comment">//编辑框画自定义的按钮还没尝试其他方法... 后续尝试下新的放方法</span></span><br><span class="line">    <span class="keyword">let</span> _this = <span class="built_in">this</span>,</span><br><span class="line">        editIcon64 = <span class="string">&#x27;data:image/png;base64,...&#x27;</span></span><br><span class="line">    <span class="keyword">let</span> eidtIconImg = <span class="built_in">document</span>.createElement(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    eidtIconImg.src = editIcon64;</span><br><span class="line">    <span class="keyword">let</span>	scaleIcon64 = <span class="string">&#x27;data:image/png;base64,...&#x27;</span></span><br><span class="line">    <span class="keyword">let</span> scaleIconImg = <span class="built_in">document</span>.createElement(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    scaleIconImg.src = scaleIcon64;</span><br><span class="line">    <span class="keyword">let</span> textCloseIcon64 = <span class="string">&#x27;data:image/png;base64,...&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> textCloseIconImg = <span class="built_in">document</span>.createElement(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    textCloseIconImg.src = textCloseIcon64;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//edit即为这个新按钮的名称，可以随意取</span></span><br><span class="line">    fabric.Object.prototype.controls.edit = <span class="keyword">new</span> fabric.Control(&#123;</span><br><span class="line">        x: <span class="number">0</span>,   <span class="comment">//x y是以Object中心点为0的, 向上为Y负轴， 向左为X负轴</span></span><br><span class="line">        y: -<span class="number">0.5</span>,  <span class="comment">//0.5其实指的是 height * 0.5</span></span><br><span class="line">        offsetY: -<span class="number">30</span>,  <span class="comment">//30的单位是px </span></span><br><span class="line">        cursorStyle: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        mouseUpHandler: _this.showEditPopover,  <span class="comment">//点击事件的handler，请看下一小节</span></span><br><span class="line">        render: renderTextEditIcon,  <span class="comment">//自定义绘制按钮</span></span><br><span class="line">        cornerSize: <span class="number">32</span>, </span><br><span class="line">        visible: targetType == <span class="string">&#x27;text&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    fabric.Object.prototype.controls.scale = <span class="keyword">new</span> fabric.Control(&#123;				</span><br><span class="line">        x: <span class="number">0.5</span>,</span><br><span class="line">        y: <span class="number">0.5</span>,</span><br><span class="line">        cursorStyle: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        render: renderImageScaleIcon,</span><br><span class="line">        cornerSize: <span class="number">32</span>,</span><br><span class="line">        actionHandler:scalingEqually,</span><br><span class="line">        visible: targetType == <span class="string">&#x27;image&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    fabric.Object.prototype.controls.text_close = <span class="keyword">new</span> fabric.Control(&#123;				</span><br><span class="line">        x: <span class="number">0</span>,</span><br><span class="line">        y: <span class="number">0.5</span>,</span><br><span class="line">        offsetY: <span class="number">30</span>,</span><br><span class="line">        cursorStyle: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        render: renderTextCloseIcon,</span><br><span class="line">        cornerSize: <span class="number">32</span>,</span><br><span class="line">        mouseUpHandler: _this.deleteTextHandle,</span><br><span class="line">        visible: targetType == <span class="string">&#x27;text&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//其实我也不想在这里写function, 试了下写外面，结果绘制没成功... sad</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">renderImageScaleIcon</span>(<span class="params">ctx, left, top, styleOverride, fabricObject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> w = <span class="number">32</span>, h = <span class="number">32</span>;</span><br><span class="line">        ctx.save();</span><br><span class="line">        ctx.translate(left, top);</span><br><span class="line">        ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));</span><br><span class="line">        ctx.drawImage(scaleIconImg, -w/<span class="number">2</span>, -h/<span class="number">2</span>, w, h);</span><br><span class="line">        ctx.restore();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;draw edit box for img done&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">renderTextEditIcon</span>(<span class="params">ctx, left, top, styleOverride, fabricObject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> w = <span class="number">32</span>, h = <span class="number">32</span>;</span><br><span class="line">        ctx.save();</span><br><span class="line">        ctx.translate(left, top);</span><br><span class="line">        ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));</span><br><span class="line">        ctx.drawImage(eidtIconImg, -w/<span class="number">2</span>, -h/<span class="number">2</span>, w, h);</span><br><span class="line">        ctx.restore();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;draw edit icon for text done&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">renderTextCloseIcon</span>(<span class="params">ctx, left, top, styleOverride, fabricObject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> w = <span class="number">30</span>, h = <span class="number">30</span>;</span><br><span class="line">        ctx.save();</span><br><span class="line">        ctx.translate(left, top);</span><br><span class="line">        ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));</span><br><span class="line">        ctx.drawImage(textCloseIconImg, -w/<span class="number">2</span>, -h/<span class="number">2</span>, w, h);</span><br><span class="line">        ctx.restore();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;draw close icon for text done&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2><span id="zi-ding-yi-bian-ji-gong-neng">自定义编辑功能</span><a href="#zi-ding-yi-bian-ji-gong-neng" class="header-anchor">#</a></h2><p>在controls.edit我们指定了mouseUpHandler为showEditPopover。control.close用了一样的方式来获取点击事件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">showEditPopover: <span class="function"><span class="keyword">function</span>(<span class="params">eventData, target</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//没直接用传参</span></span><br><span class="line">    <span class="keyword">let</span> obj = <span class="built_in">this</span>.canvas.getActiveObject()</span><br><span class="line">    <span class="keyword">if</span> (!obj || obj.type != <span class="string">&#x27;text&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果是文本被点击，则弹出modle允许编辑</span></span><br><span class="line">    <span class="built_in">this</span>.showTextEditModel = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">this</span>.textEditModelContent = obj.text</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>当我们的model中修改文本内容完成，则可以用下面的方法替换画布上的文本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">confirmTextEdit: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> obj = <span class="built_in">this</span>.canvas.getActiveObject()</span><br><span class="line">    <span class="keyword">if</span> (!!obj &amp;&amp; obj.type == <span class="string">&#x27;text&#x27;</span>) &#123;</span><br><span class="line">        obj.text = <span class="built_in">this</span>.textEditModelContent</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.canvas.requestRenderAll();  <span class="comment">//重新渲染画布</span></span><br><span class="line">    <span class="built_in">this</span>.showTextEditModel = <span class="literal">false</span>  <span class="comment">//清除model</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h1><span id="lian-diao">联调</span><a href="#lian-diao" class="header-anchor">#</a></h1><p>涉及到联调的主要是这几个功能点：</p>
<ul>
<li>we-app的授权验证</li>
<li>选取移动端本地(相册)的照片</li>
<li>fabric.js生成的图片传给APP或者we-app使用</li>
</ul>
<h2><span id="1-shou-quan-yan-zheng">1. 授权验证</span><a href="#1-shou-quan-yan-zheng" class="header-anchor">#</a></h2><h4><span id="we-app">WE-APP</span><a href="#we-app" class="header-anchor">#</a></h4><p>先引入wx-jdk，我是先在index.html顶部加载，然后通过vue的配置来获取的</p>
<figure class="highlight js"><figcaption><span>vue.config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">configureWebpack: &#123;</span><br><span class="line">    externals: &#123;</span><br><span class="line">        <span class="string">&#x27;weixin-js-sdk&#x27;</span>: <span class="string">&#x27;wx&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">created: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="built_in">this</span></span><br><span class="line">    <span class="comment">//确认是否是在小程序中</span></span><br><span class="line">    wx.miniProgram.getEnv(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123; </span><br><span class="line">        <span class="built_in">console</span>.log(res.miniprogram) </span><br><span class="line">        _this.weAppEnv = res.miniprogram</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br><span class="line">mounted: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.weAppEnv) &#123;</span><br><span class="line">        <span class="built_in">this</span>.initWxConfig()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">    initWxConfig: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> url =  <span class="built_in">window</span>.location.href</span><br><span class="line">        url = url.split(<span class="string">&#x27;#&#x27;</span>)[<span class="number">0</span>]  </span><br><span class="line">        <span class="keyword">const</span> promise = axios.get(<span class="string">&#x27;/api/wechat/h5/sign/share&#x27;</span> + <span class="string">&#x27;?app_id=&#x27;</span> + <span class="built_in">this</span>.appId + <span class="string">&#x27;&amp;url=&#x27;</span> + url);</span><br><span class="line">        promise.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (res.data.code == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> sign = res.data.data;</span><br><span class="line">                <span class="built_in">this</span>._wxConfigJSSDK(sign);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        promise.catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err.response);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    _wxConfigJSSDK: <span class="function"><span class="keyword">function</span>(<span class="params">sign</span>)</span>&#123;</span><br><span class="line">        wx.config(&#123;</span><br><span class="line">            debug: <span class="literal">false</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></span><br><span class="line">            appId: sign.appId + <span class="string">&#x27;&#x27;</span>, <span class="comment">// 必填，公众号的唯一标识</span></span><br><span class="line">            timestamp: <span class="built_in">parseInt</span>(sign.timestamp), <span class="comment">// 必填，生成签名的时间戳</span></span><br><span class="line">            nonceStr: sign.nonceStr + <span class="string">&#x27;&#x27;</span>, <span class="comment">// 必填，生成签名的随机串</span></span><br><span class="line">            signature: sign.signature + <span class="string">&#x27;&#x27;</span>,<span class="comment">// 必填，签名</span></span><br><span class="line">            jsApiList: [<span class="string">&#x27;chooseImage&#x27;</span>, <span class="string">&#x27;downloadImage&#x27;</span>, <span class="string">&#x27;previewImage&#x27;</span>, <span class="string">&#x27;uploadImage&#x27;</span>] <span class="comment">// 必填，需要使用的JS接口列表</span></span><br><span class="line">        &#125;)</span><br><span class="line">        wx.ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            wx.checkJsApi(&#123;</span><br><span class="line">                jsApiList: [</span><br><span class="line">                    <span class="string">&#x27;chooseImage&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;previewImage&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;uploadImage&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;downloadImage&#x27;</span></span><br><span class="line">                ],</span><br><span class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (res.checkResult.getLocation == <span class="literal">false</span>) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.error(<span class="string">&#x27;你的微信版本太低，不支持微信JS接口，请升级到最新的微信版本！&#x27;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">&#x27;授权成功&#x27;</span>, res)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                fail: <span class="function"><span class="params">err</span>=&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(err)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        wx.error(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.error(res)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>中间涉及到一个appId,即为调用该页面的小程序关联的<strong>公众号appid</strong></li>
<li>当我们需要调用分享(APP、H5内),就需要进行签名。具体逻辑参照官方文档<ul>
<li><strong>切记</strong>将这个fabric.js所在的域名添加到公众号下的安全域名内，没错，公众号！！！和小程序关联的公众号，同主体，同开发者平台账号下</li>
<li><strong>切记</strong>将这个fabric.js所在的域名添加到小程序的合法业务域名下</li>
<li>小程序开发工具-<strong>网页模式</strong>可以用来调试当前fabric.js页面</li>
<li>小程序开发工具-小程序模式没办法使用模拟器来测试授权，必须<strong>真机测试</strong>！！！一般来说上一步的网页模式测试没问题，真机也不会有问题</li>
</ul>
</li>
<li>不涉及选择照片功能的话，<strong>可以不授权</strong>。</li>
</ol>
<h4><span id="app-rn">APP(RN)</span><a href="#app-rn" class="header-anchor">#</a></h4><p>RN内好像没涉及授权问题</p>
<h2><span id="2-xuan-ze-zhao-pian">2. 选择照片</span><a href="#2-xuan-ze-zhao-pian" class="header-anchor">#</a></h2><h4><span id="we-app">WE-APP</span><a href="#we-app" class="header-anchor">#</a></h4><p>借用wx-js-sdk来手机上的照片，也可以支持拍照。前提是完成wx.config</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">_getLocalImage: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="built_in">this</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>)=&gt;</span> &#123;</span><br><span class="line">        wx.chooseImage(&#123;</span><br><span class="line">            count: <span class="number">1</span>, <span class="comment">// 默认9</span></span><br><span class="line">            sizeType: [<span class="string">&#x27;original&#x27;</span>, <span class="string">&#x27;compressed&#x27;</span>], <span class="comment">// 可以指定是原图还是压缩图，默认二者都有</span></span><br><span class="line">            sourceType: [<span class="string">&#x27;album&#x27;</span>, <span class="string">&#x27;camera&#x27;</span>], <span class="comment">// 可以指定来源是相册还是相机，默认二者都有</span></span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> localIds = res.localIds; <span class="comment">// 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片</span></span><br><span class="line">                <span class="keyword">let</span> targetImgId = localIds[<span class="number">0</span>]</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;wkwebview is&#x27;</span> +  !!<span class="built_in">window</span>.__wxjs_is_wkwebview)</span><br><span class="line">                wx.getLocalImgData(&#123;</span><br><span class="line">                    localId: targetImgId,</span><br><span class="line">                    success: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> localData = res.localData <span class="comment">// localData是图片的base64数据，可以用img标签显示</span></span><br><span class="line">                        <span class="keyword">if</span> (localData.indexOf(<span class="string">&#x27;data:image&#x27;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">//判断是否有这样的头部 =&gt; 兼容安卓机型（安卓机不包含data头）</span></span><br><span class="line">                            localData = <span class="string">&#x27;data:image/jpeg;base64,&#x27;</span> +  localData</span><br><span class="line">                        &#125;</span><br><span class="line">                        resolve(localData)</span><br><span class="line">                    &#125;,</span><br><span class="line">                    fail: <span class="function"><span class="params">err</span>=&gt;</span> &#123;</span><br><span class="line">                        reject(err)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            fail: <span class="function"><span class="params">err</span>=&gt;</span> &#123;</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4><span id="app-rn">APP(RN)</span><a href="#app-rn" class="header-anchor">#</a></h4><p>rn中的选择照片就相对简单一点。主要是用到组件react-native-image-picker</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;Avatar</span><br><span class="line">    containerStyle=&#123;styles.avatar&#125;</span><br><span class="line">    rounded</span><br><span class="line">    size=<span class="string">&quot;large&quot;</span></span><br><span class="line">    source=&#123;&#123;</span><br><span class="line">        uri: <span class="string">&#x27;https://&#x27;</span> + <span class="built_in">this</span>.props.agent.avatar</span><br><span class="line">    &#125;&#125;</span><br><span class="line">    title=&#123;!<span class="built_in">this</span>.props.agent.avatar ? <span class="string">&#x27;店&#x27;</span>: <span class="literal">null</span>&#125;</span><br><span class="line">    &gt;</span><br><span class="line">    &lt;Avatar.Accessory </span><br><span class="line">        name=<span class="string">&quot;edit&quot;</span></span><br><span class="line">        size=&#123;<span class="number">25</span>&#125;</span><br><span class="line">        onPress=&#123;<span class="function">()=&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> options = &#123;</span><br><span class="line">                mediaType: <span class="string">&#x27;photo&#x27;</span>,</span><br><span class="line">                maxWidth: <span class="string">&#x27;320&#x27;</span>,</span><br><span class="line">                maxHeight: <span class="string">&#x27;320&#x27;</span>,</span><br><span class="line">                quality: <span class="string">&#x27;0.8&#x27;</span>,</span><br><span class="line">            &#125;, callback = <span class="keyword">async</span> (res) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span>(res &amp;&amp; res.uri) &#123;</span><br><span class="line">                    <span class="keyword">let</span> loading = Toast.loading(<span class="string">&#x27;即将上传，请稍候&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">let</span> token = <span class="keyword">await</span> applyToken()</span><br><span class="line">                    <span class="keyword">if</span>(token) &#123;</span><br><span class="line">                        Toast.remove(loading)</span><br><span class="line">                        <span class="keyword">let</span> uploadLoading = Toast.loading(<span class="string">&#x27;正在上传&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                            key = <span class="string">&#x27;agent/avatar/&#x27;</span> + <span class="built_in">this</span>.props.agent.id + <span class="string">&#x27;/&#x27;</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() + <span class="string">&#x27;.jpg&#x27;</span></span><br><span class="line">                        upload(</span><br><span class="line">                            &#123;</span><br><span class="line">                                key: key,</span><br><span class="line">                                path: res.uri.replace(<span class="string">&#x27;file://&#x27;</span>, <span class="string">&#x27;&#x27;</span>),  <span class="comment">//这个是关键</span></span><br><span class="line">                                mimeType: res.type,</span><br><span class="line">                                token: token,</span><br><span class="line">                                zone: ZONE.HUABEI,</span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="literal">null</span></span><br><span class="line">                        ).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(data)</span><br><span class="line">                            Toast.remove(uploadLoading)</span><br><span class="line">                            Toast.success(<span class="string">&#x27;上传成功&#x27;</span>, <span class="number">2</span>, <span class="function">()=&gt;</span> &#123;</span><br><span class="line">                                <span class="keyword">let</span> avatarURL = <span class="string">&#x27;oss-xxx.XXX.com/&#x27;</span> + data.key</span><br><span class="line">                                <span class="built_in">this</span>.props.updateAgentAvatar(&#123;<span class="attr">avatar</span>: avatarURL&#125;) <span class="comment">//追加同步服务器的步骤</span></span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;) .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                            <span class="built_in">console</span>.error(err)</span><br><span class="line">                            <span class="keyword">if</span> (err.code === CODE.UPLOAD_FAILURE) &#123;</span><br><span class="line">                                <span class="built_in">console</span>.log(<span class="string">&#x27;upload error&#x27;</span>)</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            launchImageLibrary(options, callback)</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">&lt;/Avatar&gt;</span><br></pre></td></tr></table></figure>
<h2><span id="3-chuan-di-shu-ju">3. 传递数据</span><a href="#3-chuan-di-shu-ju" class="header-anchor">#</a></h2><h4><span id="we-app">WE-APP</span><a href="#we-app" class="header-anchor">#</a></h4><p>H5传数据给小程序的webview，难点在于接收数据的时机和页面切换。</p>
<ul>
<li>用户点击H5上的生成海报时，先将base64数据postMsg给小程序，然后执行wx.miniProgram.redirectTo(‘url?params’)</li>
<li>嵌套H5的页面中webview绑定msgHandler接收H5传上来的数据,并存storage</li>
<li>跳转后的页面接收params, 稍作定时(假装loading)后，从storage中获取数据，转base64为本地文件展示。</li>
</ul>
<h4><span id="app-rn">APP(RN)</span><a href="#app-rn" class="header-anchor">#</a></h4><figure class="highlight js"><figcaption><span>h5</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    type: <span class="string">&#x27;generate-img&#x27;</span>,</span><br><span class="line">    img: cripedImage  <span class="comment">//base64</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">window</span>.ReactNativeWebView &amp;&amp; <span class="built_in">window</span>.ReactNativeWebView.postMessage(<span class="built_in">JSON</span>.stringify(obj))</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>rn</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为了更好的区分H5是谁调用的，可以在此webview中设置前缀script(后续再补充)</span></span><br><span class="line">&lt;WebView</span><br><span class="line">    onLoad=&#123;<span class="function">(<span class="params">e</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;onLoad&#x27;</span>)&#125;</span><br><span class="line">    onLoadEnd=&#123;<span class="function">(<span class="params">e</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;onLoadEnd&#x27;</span>)&#125;</span><br><span class="line">    onLoadStart=&#123;<span class="function">(<span class="params">e</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;onLoadStart&#x27;</span>)&#125;</span><br><span class="line">    renderError=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;renderError&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span><span class="tag">&lt;<span class="name">Text</span>&gt;</span>renderError回调了，出现错误<span class="tag">&lt;/<span class="name">Text</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">    renderLoading=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span><span class="tag">&lt;<span class="name">Text</span>&gt;</span>这是自定义Loading...<span class="tag">&lt;/<span class="name">Text</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">    source=&#123;&#123;<span class="attr">uri</span>: <span class="built_in">this</span>.state.url&#125;&#125;  <span class="comment">//h5页面地址</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">marginTop</span>: <span class="number">20</span>&#125;&#125;</span><br><span class="line">    onMessage=&#123;<span class="built_in">this</span>._onMessage&#125;  <span class="comment">//接收上面传过来的参数</span></span><br><span class="line">/&gt;</span><br><span class="line">_onMessage = <span class="function">(<span class="params">event</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> webString = event.nativeEvent ? event.nativeEvent.data : <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span>(webString) &#123;</span><br><span class="line">        <span class="keyword">let</span> obj = <span class="built_in">JSON</span>.parse(webString)</span><br><span class="line">        <span class="keyword">if</span>(obj &amp;&amp; obj.type == <span class="string">&#x27;generate-img&#x27;</span>) &#123;</span><br><span class="line">            Actions[<span class="string">&#x27;poster-preview&#x27;</span>](&#123;</span><br><span class="line">                img: obj.img</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;H5-&gt;RN传参错误&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1><span id="note">NOTE</span><a href="#note" class="header-anchor">#</a></h1><h2><span id="safearea">safeArea</span><a href="#safearea" class="header-anchor">#</a></h2><h2><span id="qrcode-er-wei-ma">qrcode 二维码</span><a href="#qrcode-er-wei-ma" class="header-anchor">#</a></h2><h2><span id="fabricobject-zi-ding-yi-fu-jia-zi-duan">fabricObject自定义附加字段</span><a href="#fabricobject-zi-ding-yi-fu-jia-zi-duan" class="header-anchor">#</a></h2><h2><span id="fu-wu-duan-chu-li">服务端处理</span><a href="#fu-wu-duan-chu-li" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/Rookie-Birds/Fabric-Tutorial_zh-CN/blob/master/part-4.md">参考文档</a></p>
<h2><span id="jie-qu-zhi-ding-qu-yu">截取指定区域</span><a href="#jie-qu-zhi-ding-qu-yu" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/fabricjs/fabric.js/blob/7de3b1f9ad8be1b4669272d4f736e0913d00525c/src/mixins/canvas_dataurl_exporter.mixin.js">参考文档</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Exports canvas element to a dataurl image. Note that when multiplier is used, cropping is scaled appropriately</span></span><br><span class="line"><span class="comment">* @param &#123;Object&#125; [options] Options object</span></span><br><span class="line"><span class="comment">* @param &#123;String&#125; [options.format=png] The format of the output image. Either &quot;jpeg&quot; or &quot;png&quot;</span></span><br><span class="line"><span class="comment">* @param &#123;Number&#125; [options.quality=1] Quality level (0..1). Only used for jpeg.</span></span><br><span class="line"><span class="comment">* @param &#123;Number&#125; [options.multiplier=1] Multiplier to scale by, to have consistent</span></span><br><span class="line"><span class="comment">* @param &#123;Number&#125; [options.left] Cropping left offset. Introduced in v1.2.14</span></span><br><span class="line"><span class="comment">* @param &#123;Number&#125; [options.top] Cropping top offset. Introduced in v1.2.14</span></span><br><span class="line"><span class="comment">* @param &#123;Number&#125; [options.width] Cropping width. Introduced in v1.2.14</span></span><br><span class="line"><span class="comment">* @param &#123;Number&#125; [options.height] Cropping height. Introduced in v1.2.14</span></span><br><span class="line"><span class="comment">* @param &#123;Boolean&#125; [options.enableRetinaScaling] Enable retina scaling for clone image. Introduce in 2.0.0</span></span><br><span class="line"><span class="comment">* @return &#123;String&#125; Returns a data: URL containing a representation of the object in the format specified by options.format</span></span><br><span class="line"><span class="comment">* @see &#123;@link http://jsfiddle.net/fabricjs/NfZVb/|jsFiddle demo&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// @example &lt;caption&gt;Generate jpeg dataURL with lower quality&lt;/caption&gt;</span></span><br><span class="line">    <span class="keyword">var</span> dataURL = canvas.toDataURL(&#123;</span><br><span class="line">        format: <span class="string">&#x27;jpeg&#x27;</span>,</span><br><span class="line">        quality: <span class="number">0.8</span></span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// @example &lt;caption&gt;Generate cropped png dataURL (clipping of canvas)&lt;/caption&gt;    </span></span><br><span class="line">    <span class="keyword">var</span> dataURL = canvas.toDataURL(&#123;</span><br><span class="line">        format: <span class="string">&#x27;png&#x27;</span>,</span><br><span class="line">        left: <span class="number">100</span>,</span><br><span class="line">        top: <span class="number">100</span>,</span><br><span class="line">        width: <span class="number">200</span>,</span><br><span class="line">        height: <span class="number">200</span></span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// @example &lt;caption&gt;Generate double scaled png dataURL&lt;/caption&gt;</span></span><br><span class="line">    <span class="keyword">var</span> dataURL = canvas.toDataURL(&#123;</span><br><span class="line">        format: <span class="string">&#x27;png&#x27;</span>,</span><br><span class="line">       multiplier: <span class="number">2</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2><span id="zi-ti">字体</span><a href="#zi-ti" class="header-anchor">#</a></h2><p>Q: 小程序内嵌H5， H5使用fabric, 但画布上的英文字很明显不是选用的字体? (后来发现这个是Times New Roman)<br>A: 最开始怀疑是微信浏览器最字体做了限制，<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/ui/font/wx.loadFontFace.html">官方文档</a>,<br>后台注意到嵌入fabric的H5页面，非canvas内部的字体并没有受到影响。至此：</p>
<ul>
<li>字体支持应该是设置的字体在电脑端(测试时)存在，但真机时并没有</li>
<li>尝试在真机上设置Text的字体为苹方，上述猜想得到证实</li>
<li>接下来就是得想办法让真机能支持自己设置的字体-&gt; <code>区分机型，并为不同机型寻找合适的字体</code><br>PS: 至于node端设置字体，请参考这个<a target="_blank" rel="noopener" href="https://github.com/Rookie-Birds/Fabric-Tutorial_zh-CN/blob/master/part-4.md">文章</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>canvas-weapp-h5</p><p><a href="http://thetiso.github.io/2020/12/28/canvas-weapp-h5/">http://thetiso.github.io/2020/12/28/canvas-weapp-h5/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Thetiso</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-12-28</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-01-20</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/fabric-js/">fabric.js</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/01/08/vue-step-by-step/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">vue-step-by-step</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/12/10/nginx%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E4%BC%98%E5%8C%96/"><span class="level-item">nginx静态网站优化</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "55906688ac3ee6ab589149524d34569f",
            repo: "blog-site-comments",
            owner: "thetiso",
            clientID: "6fc0041775b201d6de94",
            clientSecret: "6e7e41e3c9efa52eaa1712f435f3890d4325596b",
            admin: ["thetiso"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Thetiso&#039;s Tech Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 Thetiso</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>